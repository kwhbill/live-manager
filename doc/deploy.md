#1、部署背景



部署常面临：

-   Git本地和线上不一致；

-   公用代码影响其余产品；

-   相关后端功能、运维支撑未及时部署

-   \...

针对上述情况，做了一些规范措施：

-   版本分支过多、本地线上不一致：

    -   一个部署目标，部署模块统一Git Branch

    -   使用脚本自动更新、检测、编译

-   部署回退繁琐：

    -   部署模块编译代码，汇集至预部署Git（zj\_front\_deploy）

    -   可简单在预部署Git进行回退

-   忙中有错，疏忽依赖处理：

    -   制定部署计划表，按步骤和要点逐步确认，规避疏漏

#2、部署流程

##2.1、整理部署计划，根据实际情况填写表格

| 部署环节 | 要点             | 描述                     | 结果 |
| -------- | ---------------- | ------------------------ | ---- |
| 预部署   | 目的             | 部署业务代码 | -    |
|          | 分支             | opms                  | -    |
|          | 知会前端人员     | 烁娥、...                | Y    |
|          | 提交预部署代码   |                          | Y    |
| 部署     | 相关运维服务     | nginx配置、...           | -    |
|          | 相关后端服务     | 菜单修改、接口...        | -    |
|          | 测试环境部署确认 | test6                    | Y    |
|          | 正式环境部署确认 | 03-20am9:00, 中梁        | Y    |

##2.2、预部署

###2.2.1、根据部署表格确认预备环境

###2.2.2、生成部署代码

使用命令生成预部署代码到zj\_front\_deploy中 -\> 在zj\_front\_deploy中确认修改代码 -\>提交代码

注：

-   生成部署代码命令

    -   **例如：预部署业务代码的opms分支（BRANCH=opms yarn prod-deploy）**

    -   **预部署公共入口的opmsr分支（BRANCH=opms yarn portal-deploy）**

-   提交代码命令

    -   **git add . -\> git commit -m 'xxx' -\> git push -u origin opms

##2.3、部署

###2.3.1、在计划表格中确认部署预备环境

###2.3.2、部署测试环境

登录跳板机（**ssh linshuoe@106.75.153.251**）-\> 选择服务器类型（**go\_deployer**）-\> (输入**deploy\_py**) -\> 选择部署文件序号(**zj\_front\_deploy\_public：41**) -\> 输入要部署的zj\_deploy的分支，默认为master -\> 选择部署环境序号（**test6： 6**）-\> 输入部署环境密码 -\> 完成部署。

###2.3.3、自测确认功能

###2.3.4、部署线上（按照部署测试环境的步骤部署至线上）

###2.3.5、根据部署结果通知相关人员

#3、附录

##3.1、部署计划表模版地址

<https://shimo.im/sheet/LdLhZNW6NyM8gF6S/2FTH2/>

##3.2、部署计划表的意义和作用

针对一些比较繁杂多人协作的情况，我们需要有一个清晰具体的确认环节，规避疏漏。将总结出来的注意点以表格的形式呈现，有助于部署人员清晰有顺序地进行确认。

##3.3、部署计划表的使用说明

-   每个sheet对应一个部署计划表，打开Excel表格可查看近期多个待办部署计划。

-   以部署目标为单位。若有新的部署目标，则基于模板快速创建部署计划表。

-   根据表格逐一确认完，发给其他关联同事确认，待表格确认完毕后可自行删除。
